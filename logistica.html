<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Logística - Gigas</title>

  <!-- Tailwind CSS para um design moderno -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome para ícones -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
    }
    .toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 25px;
      border-radius: 8px;
      background: #3a7dff;
      color: white;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-weight: 500;
      transition: bottom 0.5s ease-in-out, opacity 0.5s ease-in-out;
      opacity: 0;
      z-index: 1000;
    }
    .toast.show { bottom: 30px; opacity: 1; }
    .toast.error { background: #e53935; }
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .badge-pendente { background-color: #fca5a5; color: #7f1d1d; }
    .badge-em-rota { background-color: #fcd34d; color: #92400e; }
    .badge-entregue { background-color: #6ee7b7; color: #065f46; }

    /* Estilo do modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      transform: scale(0.9);
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    /* Estilo para a barra de pesquisa */
    #searchBar {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      width: 100%;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-blue-800 text-white p-4 text-center font-bold text-xl md:text-2xl shadow-lg">
    <i class="fas fa-shipping-fast text-yellow-300"></i> Painel de Logística
  </header>

  <div class="container mx-auto p-4 md:p-8">

    <!-- Dashboard de Indicadores e Gráfico -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-lg text-center">
        <p class="text-xl font-semibold text-gray-500">Total de Pedidos</p>
        <h3 id="totalPedidos" class="text-4xl font-bold text-blue-800 mt-2">0</h3>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg text-center">
        <p class="text-xl font-semibold text-gray-500">Pedidos em Rota</p>
        <h3 id="pedidosEmRota" class="text-4xl font-bold text-yellow-600 mt-2">0</h3>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-lg text-center">
        <p class="text-xl font-semibold text-gray-500">Tempo Médio</p>
        <h3 id="tempoMedio" class="text-4xl font-bold text-green-600 mt-2">--</h3>
      </div>
    </section>

    <!-- Gráficos de Entregas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-blue-800 mb-4 text-center">
                <i class="fas fa-chart-line"></i> Entregas Concluídas por Dia
            </h2>
            <canvas id="dailyDeliveriesChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-blue-800 mb-4 text-center">
                <i class="fas fa-chart-bar"></i> Entregas Concluídas por Mês
            </h2>
            <canvas id="monthlyDeliveriesChart"></canvas>
        </div>
    </div>
    
    <!-- Tabela de Pedidos -->
    <section class="bg-white p-6 rounded-xl shadow-lg mb-8 overflow-x-auto">
      <h2 class="text-2xl font-bold text-blue-800 mb-4">
        <i class="fas fa-clipboard-list"></i> Pedidos para Entrega
      </h2>

      <!-- Botões de Filtro -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="filtroTodos" class="bg-gray-200 text-gray-700 p-2 rounded-lg text-sm font-semibold hover:bg-gray-300 transition-colors duration-200">
          Todos
        </button>
        <button id="filtroPendentes" class="bg-red-200 text-red-700 p-2 rounded-lg text-sm font-semibold hover:bg-red-300 transition-colors duration-200">
          A Enviar
        </button>
        <button id="filtroEmRota" class="bg-yellow-200 text-yellow-700 p-2 rounded-lg text-sm font-semibold hover:bg-yellow-300 transition-colors duration-200">
          Já Saiu
        </button>
        <button id="filtroConcluidos" class="bg-green-200 text-green-700 p-2 rounded-lg text-sm font-semibold hover:bg-green-300 transition-colors duration-200">
          Concluído
        </button>
      </div>
      
      <!-- Campo de pesquisa -->
      <input type="text" id="searchBar" placeholder="Pesquisar por ID, cliente ou entregador..." />

      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entregador</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tempo</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
          </tr>
        </thead>
        <tbody id="tabela-pedidos" class="bg-white divide-y divide-gray-200">
          <!-- Linhas de pedidos serão injetadas aqui -->
        </tbody>
      </table>
    </section>
    
    <!-- Botão de Voltar para o menu principal -->
    <div class="text-center mt-8">
      <a href="index.html" class="inline-block bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-200">
        <i class="fas fa-arrow-left"></i> Voltar ao Menu
      </a>
    </div>

  </div>

  <!-- Modal para inserir o nome do entregador -->
  <div id="entregadorModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-xl font-bold text-blue-800 mb-4">Atribuir Entregador</h3>
      <input type="text" id="entregadorNome" placeholder="Nome do entregador" class="w-full p-3 border rounded-lg mb-4" />
      <div class="flex justify-end gap-2">
        <button id="fecharEntregador" class="bg-gray-300 text-gray-800 p-3 rounded-lg font-semibold hover:bg-gray-400">Cancelar</button>
        <button id="confirmarEntregador" class="bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal para ver detalhes do pedido -->
  <div id="detalhesModal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-blue-800">Detalhes do Pedido</h3>
        <button id="fecharDetalhes" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      </div>
      <div id="detalhesConteudo">
        <!-- Conteúdo do pedido será injetado aqui -->
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from "./firebase.js";
    import { collection, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    
    // Elementos da UI
    const totalPedidosEl = document.getElementById('totalPedidos');
    const pedidosEmRotaEl = document.getElementById('pedidosEmRota');
    const tempoMedioEl = document.getElementById('tempoMedio');
    const tabelaPedidosEl = document.getElementById('tabela-pedidos');
    const searchBar = document.getElementById('searchBar');
    const entregadorModal = document.getElementById('entregadorModal');
    const fecharEntregadorBtn = document.getElementById('fecharEntregador');
    const confirmarEntregadorBtn = document.getElementById('confirmarEntregador');
    const entregadorNomeInput = document.getElementById('entregadorNome');
    const detalhesModal = document.getElementById('detalhesModal');
    const fecharDetalhesBtn = document.getElementById('fecharDetalhes');
    const detalhesConteudo = document.getElementById('detalhesConteudo');
    
    let dailyDeliveriesChart;
    let monthlyDeliveriesChart;
    let todosPedidos = [];
    let pedidosVisiveis = [];
    let filtroAtual = 'todos';
    let pedidoParaAtualizar = null;
    let intervaloTempos = {};

    // Mapeamento de status para nomes amigáveis
    const statusMap = {
        'pendente': 'Pendente',
        'em-rota': 'Em Rota',
        'entregue': 'Entregue'
    };

    // Função de notificação personalizada (Toast)
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
      }, 10);
    }
    
    // Funções para gráficos
    function processarDadosGraficos(pedidos) {
        const dailyData = {};
        const monthlyData = {};
        pedidos.forEach(p => {
            if (p.status === 'entregue' && p.horarioEntrega) {
                const entrega = new Date(p.horarioEntrega);
                const dia = entrega.toLocaleDateString('pt-BR', { weekday: 'short' });
                const mes = entrega.toLocaleDateString('pt-BR', { month: 'short' });

                dailyData[dia] = (dailyData[dia] || 0) + 1;
                monthlyData[mes] = (monthlyData[mes] || 0) + 1;
            }
        });
        return { dailyData, monthlyData };
    }

    function atualizarGraficos(pedidos) {
        const { dailyData, monthlyData } = processarDadosGraficos(pedidos);
        const diasSemana = ['Dom.', 'Seg.', 'Ter.', 'Qua.', 'Qui.', 'Sex.', 'Sáb.'];
        const mesesAno = ['Jan.', 'Fev.', 'Mar.', 'Abr.', 'Mai.', 'Jun.', 'Jul.', 'Ago.', 'Set.', 'Out.', 'Nov.', 'Dez.'];
        
        // Gráfico Diário
        const dailyLabels = diasSemana;
        const dailyCounts = diasSemana.map(dia => dailyData[dia] || 0);
        if (dailyDeliveriesChart) {
            dailyDeliveriesChart.data.labels = dailyLabels;
            dailyDeliveriesChart.data.datasets[0].data = dailyCounts;
            dailyDeliveriesChart.update();
        } else {
            const ctx = document.getElementById('dailyDeliveriesChart').getContext('2d');
            dailyDeliveriesChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: dailyLabels, datasets: [{ label: 'Entregas', data: dailyCounts, backgroundColor: 'rgba(58, 125, 255, 0.7)' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }

        // Gráfico Mensal
        const monthlyLabels = mesesAno;
        const monthlyCounts = mesesAno.map(mes => monthlyData[mes] || 0);
        if (monthlyDeliveriesChart) {
            monthlyDeliveriesChart.data.labels = monthlyLabels;
            monthlyDeliveriesChart.data.datasets[0].data = monthlyCounts;
            monthlyDeliveriesChart.update();
        } else {
            const ctx = document.getElementById('monthlyDeliveriesChart').getContext('2d');
            monthlyDeliveriesChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: monthlyLabels, datasets: [{ label: 'Entregas', data: monthlyCounts, backgroundColor: 'rgba(6, 214, 160, 0.7)' }] },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        }
    }

    // Função para calcular e exibir o tempo na rua
    function atualizarTempoNaRua() {
        pedidosVisiveis.forEach(pedido => {
            const tempoEl = document.getElementById(`tempo-${pedido.id}`);
            if (tempoEl && pedido.status === 'em-rota' && pedido.horarioSaida) {
                const saida = new Date(pedido.horarioSaida);
                const agora = new Date();
                const diffMinutos = Math.floor((agora.getTime() - saida.getTime()) / (1000 * 60));
                const horas = Math.floor(diffMinutos / 60);
                const minutos = diffMinutos % 60;
                tempoEl.textContent = `${horas}h ${minutos}m`;
            }
        });
    }

    // Função para renderizar os pedidos na tabela, aplicando o filtro e pesquisa
    function renderizarPedidos() {
      tabelaPedidosEl.innerHTML = '';
      let tempoTotal = 0;
      let entregasConcluidas = 0;
      
      const termoBusca = searchBar.value.toLowerCase();
      
      pedidosVisiveis = todosPedidos.filter(p => {
          const statusMatch = (filtroAtual === 'todos' || p.status === filtroAtual);
          const searchMatch = termoBusca === '' || 
                              p.id.toLowerCase().includes(termoBusca) ||
                              (p.cliente && p.cliente.toLowerCase().includes(termoBusca)) ||
                              (p.entregador && p.entregador.toLowerCase().includes(termoBusca));
          return statusMatch && searchMatch;
      });

      // Limpa os intervalos de tempo antigos
      Object.values(intervaloTempos).forEach(clearInterval);
      intervaloTempos = {};

      pedidosVisiveis.forEach(pedido => {
        if (pedido.status === 'entregue' && pedido.horarioSaida && pedido.horarioEntrega) {
          const saida = new Date(pedido.horarioSaida);
          const entrega = new Date(pedido.horarioEntrega);
          tempoTotal += (entrega.getTime() - saida.getTime()) / (1000 * 60); // Em minutos
          entregasConcluidas++;
        }
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-100 transition-colors duration-200';

        let statusBadge = '';
        let acoesBotoes = '';
        let tempoNaRua = '--';
        
        if (pedido.status === 'pendente') {
          statusBadge = `<span class="status-badge badge-pendente">A Enviar</span>`;
          acoesBotoes = `<button onclick="abrirEntregadorModal('${pedido.id}')" class="bg-yellow-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition-colors duration-200 mr-2">
                            <i class="fas fa-truck"></i> Enviar
                         </button>`;
        } else if (pedido.status === 'em-rota') {
          statusBadge = `<span class="status-badge badge-em-rota">Já Saiu</span>`;
          tempoNaRua = `<span id="tempo-${pedido.id}">0h 0m</span>`;
          intervaloTempos[pedido.id] = setInterval(atualizarTempoNaRua, 60000);
          acoesBotoes = `<button onclick="atualizarStatus('${pedido.id}', 'entregue')" class="bg-green-500 text-white p-2 rounded-lg text-sm font-semibold hover:bg-green-600 transition-colors duration-200">
                            <i class="fas fa-check-circle"></i> Concluir
                         </button>`;
        } else {
          statusBadge = `<span class="status-badge badge-entregue">Concluído</span>`;
          const saida = new Date(pedido.horarioSaida);
          const entrega = new Date(pedido.horarioEntrega);
          const diffMinutos = Math.floor((entrega.getTime() - saida.getTime()) / (1000 * 60));
          const horas = Math.floor(diffMinutos / 60);
          const minutos = diffMinutos % 60;
          tempoNaRua = `${horas}h ${minutos}m`;
          acoesBotoes = `<span>Finalizado <i class="fas fa-check"></i></span>`;
        }
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${pedido.id.substring(0, 5)}...</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pedido.cliente || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${pedido.entregador || 'N/A'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tempoNaRua}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${acoesBotoes}
            <button onclick="abrirDetalhesModal('${pedido.id}')" class="bg-gray-200 text-gray-700 p-2 rounded-lg text-sm font-semibold hover:bg-gray-300 transition-colors duration-200">
                <i class="fas fa-eye"></i>
            </button>
          </td>
        `;
        tabelaPedidosEl.appendChild(row);
      });
      
      totalPedidosEl.textContent = todosPedidos.length;
      pedidosEmRotaEl.textContent = todosPedidos.filter(p => p.status === 'em-rota').length;
      
      if (entregasConcluidas > 0) {
        const tempoMedio = tempoTotal / entregasConcluidas;
        tempoMedioEl.textContent = `${tempoMedio.toFixed(1)} min`;
      } else {
        tempoMedioEl.textContent = `--`;
      }
    }
    
    // Funções para os modais
    window.abrirEntregadorModal = (id) => {
        pedidoParaAtualizar = id;
        entregadorModal.classList.add('active');
        entregadorNomeInput.focus();
    };

    window.abrirDetalhesModal = (id) => {
        const pedido = todosPedidos.find(p => p.id === id);
        if (!pedido) {
            showToast("Pedido não encontrado.", 'error');
            return;
        }
        
        detalhesConteudo.innerHTML = `
            <p><strong>ID:</strong> ${pedido.id}</p>
            <p><strong>Cliente:</strong> ${pedido.cliente || 'N/A'}</p>
            <p><strong>Endereço:</strong> ${pedido.endereco || 'N/A'}</p>
            <p><strong>Status:</strong> <span class="status-badge badge-${pedido.status}">${statusMap[pedido.status]}</span></p>
            <p class="mt-4 font-bold">Itens do Pedido:</p>
            <ul class="list-disc list-inside space-y-1">
                ${pedido.itens.map(item => `<li>${item.nome} (${item.quantidade}) - R$ ${(parseFloat(item.preco) * item.quantidade).toFixed(2)}</li>`).join('')}
            </ul>
            <p class="mt-4 text-right font-bold text-xl">Total: R$ ${pedido.total.toFixed(2)}</p>
        `;
        detalhesModal.classList.add('active');
    };

    confirmarEntregadorBtn.addEventListener('click', async () => {
        const nomeEntregador = entregadorNomeInput.value;
        if (!nomeEntregador) {
            showToast("Nome do entregador é obrigatório.", 'error');
            return;
        }
        await atualizarStatus(pedidoParaAtualizar, 'em-rota', nomeEntregador);
        entregadorModal.classList.remove('active');
        entregadorNomeInput.value = '';
    });

    fecharEntregadorBtn.addEventListener('click', () => {
        entregadorModal.classList.remove('active');
    });

    fecharDetalhesBtn.addEventListener('click', () => {
        detalhesModal.classList.remove('active');
    });

    // Função global para atualizar o status do pedido
    window.atualizarStatus = async (id, novoStatus, nomeEntregador = null) => {
      const pedidoRef = doc(db, "pedidos", id);
      try {
        if (novoStatus === 'em-rota') {
          await updateDoc(pedidoRef, { status: novoStatus, horarioSaida: new Date().toISOString(), entregador: nomeEntregador });
          showToast(`Pedido ${id.substring(0,5)}... enviado para rota!`, 'success');
        } else if (novoStatus === 'entregue') {
          await updateDoc(pedidoRef, { status: novoStatus, horarioEntrega: new Date().toISOString() });
          showToast(`Pedido ${id.substring(0,5)}... entregue com sucesso!`, 'success');
        }
      } catch (e) {
        showToast(`Erro ao atualizar pedido: ${e.message}`, 'error');
      }
    };
    
    // Observador em tempo real dos pedidos
    onSnapshot(collection(db, "pedidos"), (snapshot) => {
      todosPedidos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderizarPedidos();
      atualizarGraficos(todosPedidos);
      atualizarTempoNaRua();
    });

    // Event listeners para os botões de filtro e pesquisa
    document.getElementById('filtroTodos').addEventListener('click', () => {
        filtroAtual = 'todos';
        renderizarPedidos();
    });
    document.getElementById('filtroPendentes').addEventListener('click', () => {
        filtroAtual = 'pendente';
        renderizarPedidos();
    });
    document.getElementById('filtroEmRota').addEventListener('click', () => {
        filtroAtual = 'em-rota';
        renderizarPedidos();
    });
    document.getElementById('filtroConcluidos').addEventListener('click', () => {
        filtroAtual = 'entregue';
        renderizarPedidos();
    });
    searchBar.addEventListener('input', () => {
        renderizarPedidos();
    });

  </script>
</body>
</html>
