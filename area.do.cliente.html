<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Área do Cliente - Gigas</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC4h0J54TZqT8XXUsPSL3_ABVJQ05yP4Hc",
      authDomain: "giovanigas-d959b.firebaseapp.com",
      projectId: "giovanigas-d959b",
      storageBucket: "giovanigas-d959b.appspot.com",
      messagingSenderId: "728326355548",
      appId: "1:728326355548:web:9dda06e1c1148337618499",
      measurementId: "G-ESHC9P6XGZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    // Login check
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "home.html"; 
      } else {
        currentUser = user;
        document.getElementById("userEmail").innerText = user.email;
        carregarDadosCliente(user.uid);
        carregarPedidos(user.uid);
      }
    });

    // Carregar dados do cliente
    async function carregarDadosCliente(uid) {
      const docRef = doc(db, "clientes", uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("nome").value = data.nome || "";
        document.getElementById("endereco").value = data.endereco || "";
        document.getElementById("telefone").value = data.telefone || "";
      }
    }

    // Salvar alterações do cliente
    async function salvarCliente() {
      if (!currentUser) return;
      await setDoc(doc(db, "clientes", currentUser.uid), {
        nome: document.getElementById("nome").value,
        endereco: document.getElementById("endereco").value,
        telefone: document.getElementById("telefone").value,
        email: currentUser.email
      }, { merge: true });
      alert("Dados atualizados com sucesso!");
    }
    window.salvarCliente = salvarCliente;

    // Carregar pedidos em tempo real
    function carregarPedidos(uid) {
      const q = query(collection(db, "pedidos"), where("clienteId", "==", uid));
      onSnapshot(q, (querySnapshot) => {
        let pedidosHTML = "";
        let pedidosPorMes = {};
        let finalizados = 0, pendentes = 0;

        querySnapshot.forEach((pedido) => {
          const p = pedido.data();
          pedidosHTML += `
            <li>
              <b>Produto:</b> ${p.produto} <br>
              <b>Status:</b> ${p.status} <br>
              <b>Data:</b> ${p.data}
            </li>
          `;

          // Contagem para dashboard
          const mes = p.data ? p.data.substring(3, 10) : "Desconhecido"; 
          pedidosPorMes[mes] = (pedidosPorMes[mes] || 0) + 1;
          if (p.status === "Entregue") finalizados++; else pendentes++;
        });

        document.getElementById("listaPedidos").innerHTML = pedidosHTML || "<li>Nenhum pedido encontrado.</li>";
        atualizarDashboard(pedidosPorMes, finalizados, pendentes);
      });
    }

    // Atualizar gráficos
    function atualizarDashboard(pedidosPorMes, finalizados, pendentes) {
      const ctx1 = document.getElementById('graficoPedidosMes').getContext('2d');
      new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: Object.keys(pedidosPorMes),
          datasets: [{
            label: 'Pedidos por Mês',
            data: Object.values(pedidosPorMes),
            backgroundColor: '#004aad'
          }]
        }
      });

      const ctx2 = document.getElementById('graficoStatus').getContext('2d');
      new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Finalizados', 'Pendentes'],
          datasets: [{
            data: [finalizados, pendentes],
            backgroundColor: ['#28a745', '#ffc107']
          }]
        }
      });
    }

    // Logout
    function logout() {
      signOut(auth).then(() => window.location.href = "home.html");
    }
    window.logout = logout;

  </script>

  <style>
    body { font-family: 'Montserrat', sans-serif; margin: 0; background: #f4f6f9; }
    header { background: #004aad; color: #fff; padding: 15px; text-align: center; }
    h1 { margin: 10px 0; }
    .container { padding: 20px; }
    input, button {
      width: 100%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc;
    }
    button { background: #004aad; color: #fff; font-weight: bold; cursor: pointer; }
    button:hover { background: #003580; }
    ul { list-style: none; padding: 0; }
    li { background: #fff; margin: 10px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .logout { background: #e63946; }
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
    canvas { background: #fff; border-radius: 8px; padding: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Área do Cliente</h1>
    <p>Bem-vindo: <span id="userEmail"></span></p>
    <button class="logout" onclick="logout()">Sair</button>
  </header>

  <div class="container">
    <h2>Meus Dados</h2>
    <input type="text" id="nome" placeholder="Nome completo">
    <input type="text" id="endereco" placeholder="Endereço">
    <input type="text" id="telefone" placeholder="Telefone">
    <button onclick="salvarCliente()">Salvar alterações</button>

    <h2>Meus Pedidos</h2>
    <ul id="listaPedidos"></ul>

    <h2>Dashboard</h2>
    <div class="dashboard">
      <canvas id="graficoPedidosMes"></canvas>
      <canvas id="graficoStatus"></canvas>
    </div>
  </div>
</body>
</html>
