<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Pedidos - Gigas</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
    h2 { text-align: center; }
    .lista { max-width: 600px; margin: auto; }
    .item { background: #fff; margin: 10px 0; padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
    .item img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
    .item div { flex: 1; margin-left: 10px; }
    .total { text-align: right; font-size: 18px; margin-top: 20px; }
    select, button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 6px; }
    button { background: #004aad; color: #fff; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Meu Carrinho</h2>
  <div class="lista" id="listaCarrinho"></div>
  <div class="total" id="total">Total: R$ 0,00</div>

  <div class="lista">
    <label>Forma de Pagamento:</label>
    <select id="pagamento">
      <option value="pix">PIX</option>
      <option value="cartao">Cartão de Crédito</option>
      <option value="dinheiro">Dinheiro na Entrega</option>
    </select>
    <button onclick="finalizarPedido()">Finalizar Pedido</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4h0J54TZqT8XXUsPSL3_ABVJQ05yP4Hc",
      authDomain: "giovanigas-d959b.firebaseapp.com",
      projectId: "giovanigas-d959b",
      storageBucket: "giovanigas-d959b.appspot.com",
      messagingSenderId: "728326355548",
      appId: "1:728326355548:web:9dda06e1c1148337618499",
      measurementId: "G-ESHC9P6XGZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const lista = document.getElementById("listaCarrinho");
    const totalDiv = document.getElementById("total");
    let total = 0;
    let itensCarrinho = [];
    let uid = null;

    // Carregar carrinho do usuário
    onAuthStateChanged(auth, async user => {
      if (user) {
        uid = user.uid;
        await carregarCarrinho();
      } else {
        lista.innerHTML = "<p>Você precisa estar logado para ver seus pedidos.</p>";
      }
    });

    async function carregarCarrinho() {
      lista.innerHTML = "";
      total = 0;
      itensCarrinho = [];
      const snap = await getDocs(collection(db, "carrinho", uid, "itens"));
      snap.forEach(docSnap => {
        const item = docSnap.data();
        total += Number(item.preco);
        itensCarrinho.push(item);

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <img src="${item.foto}" alt="${item.nome}">
          <div>
            <h4>${item.nome}</h4>
            <p>R$ ${item.preco}</p>
          </div>
          <button onclick="removerItem('${docSnap.id}')">❌</button>
        `;
        lista.appendChild(div);
      });
      totalDiv.innerText = "Total: R$ " + total.toFixed(2);
    }

    // Remover item do carrinho
    window.removerItem = async function(id) {
      await deleteDoc(doc(db, "carrinho", uid, "itens", id));
      carregarCarrinho();
    }

    // Finalizar pedido
    window.finalizarPedido = async function() {
      if (itensCarrinho.length === 0) {
        alert("Carrinho vazio!");
        return;
      }
      const pagamento = document.getElementById("pagamento").value;
      await addDoc(collection(db, "pedidos", uid, "lista"), {
        itens: itensCarrinho,
        total,
        pagamento,
        data: new Date()
      });

      // Limpar carrinho
      const snap = await getDocs(collection(db, "carrinho", uid, "itens"));
      for (const d of snap.docs) {
        await deleteDoc(doc(db, "carrinho", uid, "itens", d.id));
      }

      lista.innerHTML = "";
      totalDiv.innerText = "Total: R$ 0,00";
      alert("Pedido finalizado com sucesso!");
    }
  </script>
</body>
</html>
