<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clientes - Gigas</title>

  <!-- Tailwind CSS para um design moderno e responsivo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome para ícones -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f4f8;
    }
    .toast {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 25px;
      border-radius: 8px;
      background: #3a7dff;
      color: white;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      font-weight: 500;
      transition: bottom 0.5s ease-in-out, opacity 0.5s ease-in-out;
      opacity: 0;
      z-index: 1000;
    }
    .toast.show { bottom: 30px; opacity: 1; }
    .toast.error { background: #e53935; }
    
    /* Estilo do modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      max-width: 500px;
      width: 90%;
      transform: scale(0.9);
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1);
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-blue-800 text-white p-4 text-center font-bold text-xl md:text-2xl shadow-lg">
    <i class="fas fa-users text-yellow-300"></i> Gestão de Clientes
  </header>

  <div class="container mx-auto p-4 md:p-8">
    
    <!-- Seção de Cadastro de Cliente -->
    <section class="bg-white p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">
        Cadastrar Novo Cliente <i class="fas fa-user-plus text-blue-600"></i>
      </h2>

      <!-- Formulário de Cadastro -->
      <form id="clientForm" class="flex flex-col md:grid md:grid-cols-2 gap-4">
        <input type="text" id="nome" placeholder="Nome Completo" required 
               class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200" />
        <input type="tel" id="telefone" placeholder="Telefone/WhatsApp" required 
               class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200" />
        <input type="text" id="endereco" placeholder="Endereço Completo" required 
               class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200" />
        <select id="tipo" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200">
          <option value="Residencial">Residencial</option>
          <option value="Comercial">Comercial</option>
        </select>
        <textarea id="observacoes" rows="3" placeholder="Observações" 
                  class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition duration-200"></textarea>
        <button type="submit" 
                class="md:col-span-2 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
          <i class="fas fa-save"></i> Salvar Cliente
        </button>
      </form>
    </section>

    <!-- Seção de Lista de Clientes -->
    <section class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">
        Lista de Clientes <i class="fas fa-list text-blue-600"></i>
      </h2>
      <div id="clientsList" class="space-y-4">
        <!-- Cards de clientes serão injetados aqui via JS -->
      </div>
    </section>
    
    <!-- Botão de Voltar para o menu principal -->
    <div class="text-center mt-8">
      <a href="index.html" class="inline-block bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-600 transition duration-200">
        <i class="fas fa-arrow-left"></i> Voltar ao Menu
      </a>
    </div>

  </div>

  <!-- Modal de Edição de Cliente -->
  <div id="editModal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-blue-800">Editar Cliente</h3>
        <button id="fecharEditModal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      </div>
      <form id="editForm" class="flex flex-col gap-4">
        <input type="hidden" id="editId" />
        <input type="text" id="editNome" placeholder="Nome Completo" required class="p-3 border rounded-lg" />
        <input type="tel" id="editTelefone" placeholder="Telefone" required class="p-3 border rounded-lg" />
        <input type="text" id="editEndereco" placeholder="Endereço" required class="p-3 border rounded-lg" />
        <select id="editTipo" class="p-3 border rounded-lg">
          <option value="Residencial">Residencial</option>
          <option value="Comercial">Comercial</option>
        </select>
        <textarea id="editObservacoes" rows="3" placeholder="Observações" class="p-3 border rounded-lg"></textarea>
        <button type="submit" class="bg-green-500 text-white p-3 rounded-lg font-semibold">Salvar Alterações</button>
      </form>
    </div>
  </div>

  <!-- Modal de Confirmação de Exclusão -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-xl font-bold text-red-600 mb-4">Confirmar Exclusão</h3>
      <p class="mb-4">Deseja realmente excluir este cliente? Esta ação não pode ser desfeita.</p>
      <div class="flex justify-end space-x-2">
        <button id="fecharDeleteModal" class="bg-gray-300 text-gray-800 p-3 rounded-lg font-semibold hover:bg-gray-400">Cancelar</button>
        <button id="confirmarDelete" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700">Excluir</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Importa a instância do db do arquivo firebase.js centralizado
    import { db } from "./firebase.js";
    // Importa as funções do Firestore
    import { collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Elementos da UI
    const clientForm = document.getElementById("clientForm");
    const clientsList = document.getElementById("clientsList");
    const editModal = document.getElementById('editModal');
    const fecharEditModalBtn = document.getElementById('fecharEditModal');
    const editForm = document.getElementById('editForm');
    const deleteModal = document.getElementById('deleteModal');
    const fecharDeleteModalBtn = document.getElementById('fecharDeleteModal');
    const confirmarDeleteBtn = document.getElementById('confirmarDelete');
    
    let clienteParaExcluirId = null;

    // Função de notificação personalizada (Toast)
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
          toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
      }, 10);
    }

    // Função para renderizar os clientes
    function renderClients(clients) {
      clientsList.innerHTML = '';
      clients.forEach(client => {
        const card = document.createElement("div");
        card.className = "bg-white p-5 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300";
        card.innerHTML = `
          <h3 class="text-xl font-bold text-blue-800 mb-2">${client.nome}</h3>
          <p class="text-gray-600"><i class="fas fa-phone mr-2"></i> ${client.telefone}</p>
          <p class="text-gray-600"><i class="fas fa-map-marker-alt mr-2"></i> ${client.endereco}</p>
          <p class="text-gray-600"><i class="fas fa-tag mr-2"></i> ${client.tipo}</p>
          <p class="text-gray-600 mt-2 text-sm">${client.observacoes || "Sem observações"}</p>
          <div class="flex mt-4 space-x-2">
            <button class="flex-1 bg-yellow-500 text-white p-2 rounded-lg font-semibold hover:bg-yellow-600 transition-colors duration-200" 
                    data-id="${client.id}" 
                    data-nome="${client.nome}" 
                    data-telefone="${client.telefone}" 
                    data-endereco="${client.endereco}"
                    data-tipo="${client.tipo}"
                    data-obs="${client.observacoes || ''}"
                    onclick="abrirEditModal(this)">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="flex-1 bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-700 transition-colors duration-200" 
                    data-id="${client.id}"
                    onclick="abrirDeleteModal(this)">
              <i class="fas fa-trash"></i> Excluir
            </button>
          </div>
        `;
        clientsList.appendChild(card);
      });
    }

    // Observador em tempo real dos clientes
    onSnapshot(collection(db, "clientes"), (snapshot) => {
        const clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderClients(clients);
    });

    // Submissão do formulário de cadastro
    clientForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nome").value;
      const telefone = document.getElementById("telefone").value;
      const endereco = document.getElementById("endereco").value;
      const tipo = document.getElementById("tipo").value;
      const observacoes = document.getElementById("observacoes").value;

      try {
        await addDoc(collection(db, "clientes"), { nome, telefone, endereco, tipo, observacoes });
        showToast("Cliente cadastrado com sucesso!", 'success');
        clientForm.reset();
      } catch (error) {
        showToast("Erro ao cadastrar: " + error.message, 'error');
      }
    });

    // Funções para os modais
    window.abrirEditModal = (el) => {
      document.getElementById('editId').value = el.dataset.id;
      document.getElementById('editNome').value = el.dataset.nome;
      document.getElementById('editTelefone').value = el.dataset.telefone;
      document.getElementById('editEndereco').value = el.dataset.endereco;
      document.getElementById('editTipo').value = el.dataset.tipo;
      document.getElementById('editObservacoes').value = el.dataset.obs;
      editModal.classList.add('active');
    };

    window.abrirDeleteModal = (el) => {
      clienteParaExcluirId = el.dataset.id;
      deleteModal.classList.add('active');
    };

    fecharEditModalBtn.addEventListener('click', () => {
      editModal.classList.remove('active');
    });

    fecharDeleteModalBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
    });

    confirmarDeleteBtn.addEventListener('click', async () => {
      try {
        await deleteDoc(doc(db, "clientes", clienteParaExcluirId));
        showToast("Cliente excluído com sucesso!", 'success');
        deleteModal.classList.remove('active');
      } catch (error) {
        showToast("Erro ao excluir: " + error.message, 'error');
      }
    });

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editId').value;
      const nome = document.getElementById('editNome').value;
      const telefone = document.getElementById('editTelefone').value;
      const endereco = document.getElementById('editEndereco').value;
      const tipo = document.getElementById('editTipo').value;
      const observacoes = document.getElementById('editObservacoes').value;
      
      try {
        await updateDoc(doc(db, "clientes", id), { nome, telefone, endereco, tipo, observacoes });
        showToast("Cliente atualizado com sucesso!", 'success');
        editModal.classList.remove('active');
      } catch (error) {
        showToast("Erro ao atualizar: " + error.message, 'error');
      }
    });

  </script>
</body>
</html>
